@page "/Admin/ManageUser"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Identity
@using XForms.Data
@using XForms.Data.Dtos

@inject UserManager<ApplicationUser> UserManager
@inject ISnackbar Snackbar

@attribute [Authorize(Roles = "Admin")]

<MudDataGrid
   T="AdminUserManageDto"
   MultiSelection="true"
   Hover="true"
   Striped="true"
   Filterable="false"
   ServerData="LoadUsersAsync"
   Dense="true"
   @ref="_dataGrid"
   SelectedItemsChanged="@OnSelectedItemsChanged">

   <ToolBarContent>
      <MudText Typo="Typo.h6">User List</MudText>
      <MudSpacer/>
      <MudTextField
         @bind-Value="@_gridDataDto!.SearchText"
         Placeholder="Search"
         Variant="Variant.Text"
         Adornment="Adornment.End"
         Immediate="true"
         OnAdornmentClick="_dataGrid!.ReloadServerData"
         AdornmentIcon="@Icons.Material.Filled.Search"
         IconSize="Size.Medium"
         Class="mt-1"/>
      <MudSpacer/>
      <MudButtonGroup Variant="Variant.Outlined" Color="Color.Primary" OverrideStyles="false">
         <MudTooltip Text="Delete">
            <MudIconButton
               Icon="@Icons.Material.Filled.Delete"
               Color="Color.Error"
               Size="Size.Medium"
               Variant="Variant.Outlined"
               OnClick="@ToggleDeleteDialog"/>
         </MudTooltip>
         <MudTooltip Text="Block/Unblock">
            <MudIconButton
               Icon="@Icons.Material.Filled.Block"
               Color="Color.Primary"
               Variant="Variant.Outlined"
               Size="Size.Medium"
               OnClick="@ToggleBlockDialog"/>
         </MudTooltip>
         <MudButton>

         </MudButton>
      </MudButtonGroup>
   </ToolBarContent>
   <Columns>
      <SelectColumn T="AdminUserManageDto"/>
      <PropertyColumn Sortable="true" Property="u => u.DisplayName"
                      Comparer="new MudBlazor.Utilities.NaturalComparer()"/>
      <PropertyColumn Sortable="true" Property="u => u.Email"/>
      <TemplateColumn Title="Roles">
         <CellTemplate>
            @if (context.Item.Roles == string.Empty)
            {
               <MudText>N/A</MudText>
            }
            else
            {
               <MudText>@context.Item.Roles</MudText>
            }
         </CellTemplate>
      </TemplateColumn>
      <TemplateColumn Title="Block Status">
         <CellTemplate>
            @if (context.Item.IsBlocked)
            {
               <MudChip Color="Color.Error" Size="Size.Small" Icon="@Icons.Material.Filled.Lock">Blocked</MudChip>
            }
            else
            {
               <MudChip Color="Color.Success" Size="Size.Small" Icon="@Icons.Material.Filled.LockOpen">Not Blocked
               </MudChip>
            }
         </CellTemplate>
      </TemplateColumn>
   </Columns>
   <PagerContent>
      <MudDataGridPager T="AdminUserManageDto"/>
   </PagerContent>
</MudDataGrid>

<MudDialog @bind-Visible="@_deleteDialogVisible">
   <TitleContent>
      <MudText Typo="Typo.h5">Delete User?</MudText>
   </TitleContent>
   <DialogContent>
      <MudText>Do you really want to delete these users?</MudText>
   </DialogContent>
   <DialogActions>
      <MudButton OnClick="@ToggleDeleteDialog">Cancel</MudButton>
      <MudButton Variant="Variant.Filled" Color="Color.Error" OnClick="@DeleteSelectedUsers">Delete</MudButton>
   </DialogActions>
</MudDialog>
<MudDialog @bind-Visible="@_blockDialogVisible">
   <TitleContent>
      <MudText Typo="Typo.h5">Change block status?</MudText>
   </TitleContent>
   <DialogContent>
      <MudText>Do you really want to change block status of these users?</MudText>
   </DialogContent>
   <DialogActions>
      <MudButton OnClick="@ToggleBlockDialog">Cancel</MudButton>
      <MudButton Variant="Variant.Filled" Color="Color.Info" OnClick="@BlockSelectedUsers">Change</MudButton>
   </DialogActions>
</MudDialog>